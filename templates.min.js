define(["exports","lodash","async"],function(t,n,e){var i=(t.isSync=function(t){return n.isFunction(t)&&!!t.__templatesSync},t.isAsync=function(t){return n.isFunction(t)&&!!t.__templatesAsync},t.asSync=function(t){return n.isFunction(t)&&(t.__templatesSync=!0),t},t.asAsync=function(t){return n.isFunction(t)&&(t.__templatesAsync=!0),t}),s=function(t,n,e){t._render(n,e)},r=t.dataRender=function(t,i,o){if(n.isFunction(t))t.prototype instanceof d?t.prototype instanceof m?s(t()(),i,o):s(t(),i,o):t.__templatesInstance instanceof d?s(t.__templatesInstance,i,o):t.__templatesAsync?t(function(t){r(t,i,o)}):t.__templatesSync?r(t(),i,o):i(t);else if(n.isObject(t))if(t instanceof d)s(t,i,o);else{var u;u=n.isArray(t)?[]:{};var a=n.keys(t);e.each(a,function(n,e){r(t[n],function(t){u[n]=t,e()},o)},function(){i(u)})}else i(t)},o=t.wrapMethod=function(t,n){return n.__templatesInstance=t,n},u=t.regExpSearch=function(t,n){for(var e=[],i=null;null!=(i=n.exec(t));)i.index===n.lastIndex&&n.lastIndex++,e.push(i);return e},a=t._selectorRegExp=/(\[)|(\])|#([-\w\d]+)|\.([-\w\d]+)|([\w\d-]+)="(['\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]*)"|([\w\d-]+)='(["\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]*)'|([\w\d-]+)=([\w\d-:\\\/\.={}<>%@#$%^&*~`]*)|("['\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]+")|('["\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]+')|([_\w-:\\\/]+)/g,c=t.parseSelector=function(t,e){var i=u(e,a),s=!1;n.each(i,function(n){if(n[1])return void(s=!0);if(n[2])return void(s=!1);if(s){if(n[9])return void(t[n[9]]=n[10]);if(n[7])return void(t[n[7]]=n[8]);if(n[5])return void(t[n[5]]=n[6]);if(n[13])return void(t[n[13]]=null);if(n[12])return void(t[n[12]]=null);if(n[11])return void(t[n[11]]=null)}else{if(n[3])return void(t.id=n[3]);if(n[4])return void(t["class"]?t["class"]+=" "+n[4]:t["class"]=n[4])}})},h=t._stringTemplate=function(t,e,i){i(n.template(t,e))},l=t.Prototype=function(){this._parent=void 0,this._arguments=void 0,this["return"]=function(){return this},this.constructor=function(){},this.extend=function(t){function e(){if(!(this instanceof l)){s=arguments;var r=new e;return r["return"](r)}if(n.isArguments(s)){var o=s;s=void 0}else var o=arguments;this._parent=i,this._arguments=o,n.isFunction(t)&&t.call(this,i),n.isFunction(this.constructor)&&this.constructor.apply(this,o)}var i=this,s=void 0;return e.prototype=i,e}},d=t.Content=(new l).extend(function(t){this._content=void 0,this.prepend=function(){return this._content.unshift.apply(this._content,arguments),this},this.content=function(){return this._content=Array.prototype.slice.call(arguments),this},this.append=function(){return this._content.push.apply(this._content,arguments),this},this._context={},this.context=function(){for(var t in arguments)n.extend(this._context,arguments[t]);return this},this.render=function(){var t=!1,e={};for(var s in arguments)n.isFunction(arguments[s])?t=arguments[s]:n.isObject(arguments[s])&&n.extend(e,arguments[s]);t&&this._render(t,e);var r=this;return i(function(t){r._render(t,e)})},this._render=function(t,e){var i=n.extend({},this._context);n.extend(i,e),r(this._content,function(n){r(i,function(e){h(n.join(""),e,t)},i)},i)},this.constructor=function(){t.constructor.apply(this),this._content=[],n.isArray(this._parent._content)&&this._content.push.apply(this._content,this._parent._content),this._context={}}}),f=(t.content=d().extend(function(t){this.constructor=function(){t.constructor.apply(this),arguments.length>0&&this.content.apply(this,arguments)}}),t.Tag=d().extend(function(t){this._name=null,this.name=function(t){return this._name=t,this},this._attributes=null,this.attributes=function(t){return n.extend(this._attributes,t),this},this.renderAttributes=function(t,e){r(this._attributes,function(e){var i="";for(var s in e)i+=n.isNull(e[s])?" "+s:" "+s+'="'+e[s]+'"';t(i)},e)},this.selector=function(t){return c(this._attributes,t),this},this.constructor=function(){t.constructor.call(this),this._attributes=n.isObject(this._parent._attributes)?n.extend({},this._parent._attributes):{};for(var e in arguments)n.isString(arguments[e])?this.selector(arguments[e]):this.attributes(arguments[e])}})),_=t.Single=f().extend(function(t){this._quotesLeft="<",this._quotesRight="/>",this._render=function(n,e){var i=this;t._render(function(){i.renderAttributes(function(t){n(i._quotesLeft+i._name+t+i._quotesRight)},e)},e)}}),m=t.Double=f().extend(function(t){this._quotesOpenLeft="<",this._quotesOpenRight=">",this._quotesCloseLeft="</",this._quotesCloseRight=">",this["return"]=function(){var t=this;return o(t,function(){return arguments.length>0?t.content.apply(t,arguments):t})},this._render=function(n,e){var i=this;t._render.call(i,function(t){i.renderAttributes(function(e){n(i._quotesOpenLeft+i._name+e+i._quotesOpenRight+t+i._quotesCloseLeft+i._name+i._quotesCloseRight)},e)},e)}}),p=t.Doctype=f().extend(function(t){this._name="DOCTYPE",this._quotesLeft="<!",this._quotesRight=">",this._render=function(n,e){var i=this;t._render(function(){i.renderAttributes(function(t){n(i._quotesLeft+i._name+t+i._quotesRight)},e)},e)}}),g=t.doctypes={};g.html=p("[html]").extend(),g.transitional=p('[html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"]').extend(),g.strict=p('[html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"').extend(),g.frameset=p('[html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd"]').extend(),g.basic=p('[html PUBLIC "-//W3C//DTD XHTML Basic 1.1//EN" "http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd"]').extend(),g.mobile=p('[html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN" "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd"]').extend();var v=t._singles=["br","hr","img","input","base","frame","link","meta","style"],x=t.singles={};for(var b in v)x[v[b]]=_().name(v[b]).extend();var y=t._doubles=["html","body","head","h1","h2","h3","h4","h5","h6","hgroup","div","p","address","blockquote","pre","ul","ol","li","dl","dt","dd","fieldset","legend","form","noscript","object","table","thead","tbody","tfoot","tr","td","th","col","colgroup","caption","span","b","big","strong","i","var","cite","em","q","del","s","strike","tt","code","kbd","samp","small","sub","sup","dfn","bdo","abbr","acronym","a","button","textarea","select","option","article","aside","figcaption","figure","footer","header","section","main","nav","menu","audio","video","embed","canvas","output","details","summary","mark","meter","progress","template","comment","title","script"],w=t.doubles={};for(var b in y)w[y[b]]=m()().name(y[b]).extend()});