define(["exports","lodash","async"],function(t,n,e){var i=(t.isSync=function(t){return n.isFunction(t)&&!!t.__templatesSync},t.isAsync=function(t){return n.isFunction(t)&&!!t.__templatesAsync},t.asSync=function(t){return n.isFunction(t)&&(t.__templatesSync=!0),t}),s=t.asAsync=function(t){return n.isFunction(t)&&(t.__templatesAsync=!0),t},r=function(t,n,e){t._render(n,e)},o=t.dataRender=function(t,i,s){if(n.isFunction(t))t.prototype instanceof f?t.prototype instanceof g?r(t()(),i,s):r(t(),i,s):t.__templatesInstance instanceof f?r(t.__templatesInstance,i,s):t.__templatesAsync?t(function(t){o(t,i,s)}):t.__templatesSync?o(t(),i,s):i(t);else if(n.isObject(t))if(t instanceof f)r(t,i,s);else{var u;u=n.isArray(t)?[]:{};var a=n.keys(t);e.each(a,function(n,e){o(t[n],function(t){u[n]=t,e()},s)},function(){i(u)})}else i(t)},u=t.wrapMethod=function(t,n){return n.__templatesInstance=t,n},a=t.regExpSearch=function(t,n){for(var e=[],i=null;null!=(i=n.exec(t));)i.index===n.lastIndex&&n.lastIndex++,e.push(i);return e},c=t._selectorRegExp=/(\[)|(\])|#([-\w\d]+)|\.([-\w\d]+)|([\w\d-]+)="(['\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]*)"|([\w\d-]+)='(["\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]*)'|([\w\d-]+)=([\w\d-:\\\/\.={}<>%@#$%^&*~`]*)|("['\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]+")|('["\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]+')|([_\w-:\\\/]+)/g,h=t.parseSelector=function(t,e){var i=a(e,c),s=!1;n.each(i,function(n){if(n[1])return void(s=!0);if(n[2])return void(s=!1);if(s){if(n[9])return void(t[n[9]]=n[10]);if(n[7])return void(t[n[7]]=n[8]);if(n[5])return void(t[n[5]]=n[6]);if(n[13])return void(t[n[13]]=null);if(n[12])return void(t[n[12]]=null);if(n[11])return void(t[n[11]]=null)}else{if(n[3])return void(t.id=n[3]);if(n[4])return void(t["class"]?t["class"]+=" "+n[4]:t["class"]=n[4])}})},l=t._stringTemplate=function(t,e,i){i(n.template(t,e))},d=(t.mixin=function(t){if(!n.isFunction(t))throw new Error("reconstructor must be a function");_().extend(function(){var n=this._parent;this.constructor=function(){n.constructor.apply(this),this.content(i(t.apply(this,arguments)))}})},t.Prototype=function(){this._parent=void 0,this._arguments=void 0,this.returner=function(){return this},this.constructor=function(){},this.extend=function(t){function e(){if(!(this instanceof d)){s=arguments;var r=new e;return r.returner(r)}if(n.isArguments(s)){var o=s;s=void 0}else var o=arguments;this._parent=i,this._arguments=o,n.isFunction(t)&&t.call(this),n.isFunction(this.constructor)&&this.constructor.apply(this,o)}var i=this,s=void 0;return e.prototype=i,e}}),f=t.Content=(new d).extend(function(){var t=this._parent;this._content=void 0,this.prepend=function(){return this._content.unshift.apply(this._content,arguments),this},this.content=function(){return this._content=Array.prototype.slice.call(arguments),this},this.append=function(){return this._content.push.apply(this._content,arguments),this},this._context={},this.context=function(){for(var t in arguments)n.extend(this._context,arguments[t]);return this},this.render=function(){var t=!1,e={};for(var i in arguments)n.isFunction(arguments[i])?t=arguments[i]:n.isObject(arguments[i])&&n.extend(e,arguments[i]);t&&this._render(t,e);var r=this;return s(function(t){r._render(t,e)})},this._render=function(t,e){var i=n.extend({},this._context);n.extend(i,e),o(this._content,function(n){o(i,function(e){l(n.join(""),e,t)},i)},i)},this.constructor=function(){t.constructor.apply(this),this._content=[],n.isArray(this._parent._content)&&this._content.push.apply(this._content,this._parent._content),this._context={}}}),_=t.content=f().extend(function(){var t=this._parent;this.constructor=function(){t.constructor.apply(this),arguments.length>0&&this.content.apply(this,arguments)}}),p=t.Tag=f().extend(function(){var t=this._parent;this._name=null,this.name=function(t){return this._name=t,this},this._attributes=null,this.attributes=function(t){return n.extend(this._attributes,t),this},this.renderAttributes=function(t,e){o(this._attributes,function(e){var i="";for(var s in e)i+=n.isNull(e[s])?" "+s:" "+s+'="'+e[s]+'"';t(i)},e)},this.selector=function(t){return h(this._attributes,t),this},this.constructor=function(){t.constructor.call(this),this._attributes=n.isObject(this._parent._attributes)?n.extend({},this._parent._attributes):{};for(var e in arguments)n.isString(arguments[e])?this.selector(arguments[e]):this.attributes(arguments[e])}}),m=t.Single=p().extend(function(){var t=this._parent;this._quotesLeft="<",this._quotesRight="/>",this._render=function(n,e){var i=this;t._render(function(){i.renderAttributes(function(t){n(i._quotesLeft+i._name+t+i._quotesRight)},e)},e)}}),g=t.Double=p().extend(function(){var t=this._parent;this._quotesOpenLeft="<",this._quotesOpenRight=">",this._quotesCloseLeft="</",this._quotesCloseRight=">",this.returner=function(){var t=this;return u(t,function(){return arguments.length>0?t.content.apply(t,arguments):t})},this._render=function(n,e){var i=this;t._render.call(i,function(t){i.renderAttributes(function(e){n(i._quotesOpenLeft+i._name+e+i._quotesOpenRight+t+i._quotesCloseLeft+i._name+i._quotesCloseRight)},e)},e)}}),v=t.Doctype=p().extend(function(){var t=this._parent;this._name="DOCTYPE",this._quotesLeft="<!",this._quotesRight=">",this._render=function(n,e){var i=this;t._render(function(){i.renderAttributes(function(t){n(i._quotesLeft+i._name+t+i._quotesRight)},e)},e)}}),x=t.doctypes={};x.html=v("[html]").extend(),x.transitional=v('[html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"]').extend(),x.strict=v('[html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"').extend(),x.frameset=v('[html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd"]').extend(),x.basic=v('[html PUBLIC "-//W3C//DTD XHTML Basic 1.1//EN" "http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd"]').extend(),x.mobile=v('[html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN" "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd"]').extend();var b=t._singles=["br","hr","img","input","base","frame","link","meta","style"],y=t.singles={};for(var w in b)y[b[w]]=m().name(b[w]).extend();var T=t._doubles=["html","body","head","h1","h2","h3","h4","h5","h6","hgroup","div","p","address","blockquote","pre","ul","ol","li","dl","dt","dd","fieldset","legend","form","noscript","object","table","thead","tbody","tfoot","tr","td","th","col","colgroup","caption","span","b","big","strong","i","var","cite","em","q","del","s","strike","tt","code","kbd","samp","small","sub","sup","dfn","bdo","abbr","acronym","a","button","textarea","select","option","article","aside","figcaption","figure","footer","header","section","main","nav","menu","audio","video","embed","canvas","output","details","summary","mark","meter","progress","template","comment","title","script"],D=t.doubles={};for(var w in T)D[T[w]]=g()().name(T[w]).extend()});