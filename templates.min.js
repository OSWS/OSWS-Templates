define(["exports","lodash","async"],function(t,n,e){var i=(t.isSync=function(t){return n.isFunction(t)&&!!t.__templatesSync},t.isAsync=function(t){return n.isFunction(t)&&!!t.__templatesAsync},t.asSync=function(t){return n.isFunction(t)&&(t.__templatesSync=!0),t},t.asAsync=function(t){return n.isFunction(t)&&(t.__templatesAsync=!0),t},t.dataRender=function(t,s){if(n.isFunction(t))t.prototype instanceof h?t.prototype instanceof f?t()()._render(s):t()._render(s):t.__templatesInstance instanceof h?t.__templatesInstance._render(s):t.__templatesAsync?t(function(t){i(t,s)}):t.__templatesSync?i(t(),s):s(t);else if(n.isObject(t))if(t instanceof h)t._render(s);else{var r;r=n.isArray(t)?[]:{};var o=n.keys(t);e.each(o,function(n,e){i(t[n],function(t){r[n]=t,e()})},function(){s(r)})}else s(t)}),s=t.wrapMethod=function(t,n){return n.__templatesInstance=t,n},r=t.regExpSearch=function(t,n){for(var e=[],i=null;null!=(i=n.exec(t));)i.index===n.lastIndex&&n.lastIndex++,e.push(i);return e},o=t._selectorRegExp=/(\[)|(\])|#([-\w\d]+)|\.([-\w\d]+)|([\w\d-]+)="(['\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]*)"|([\w\d-]+)='(["\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]*)'|([\w\d-]+)=([\w\d-:\\\/\.={}<>%@#$%^&*~`]*)|("['\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]+")|('["\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]+')|([_\w-:\\\/]+)/g,u=t.parseSelector=function(t,e){var i=r(e,o),s=!1;n.each(i,function(n){if(n[1])return void(s=!0);if(n[2])return void(s=!1);if(s){if(n[9])return void(t[n[9]]=n[10]);if(n[7])return void(t[n[7]]=n[8]);if(n[5])return void(t[n[5]]=n[6]);if(n[13])return void(t[n[13]]=null);if(n[12])return void(t[n[12]]=null);if(n[11])return void(t[n[11]]=null)}else{if(n[3])return void(t.id=n[3]);if(n[4])return void(t["class"]?t["class"]+=" "+n[4]:t["class"]=n[4])}})},c=t._stringTemplate=function(t,e,i){i(n.template(t,e))},a=t.Prototype=function(){this._parent=void 0,this._arguments=void 0,this["return"]=function(){return this},this.constructor=function(){},this.extend=function(t){function e(){if(!(this instanceof a)){s=arguments;var r=new e;return r["return"](r)}if(n.isArguments(s)){var o=s;s=void 0}else var o=arguments;this._parent=i,this._arguments=o,n.isFunction(t)&&t.call(this,i),n.isFunction(this.constructor)&&this.constructor.apply(this,o)}var i=this,s=void 0;return e.prototype=i,e}},h=t.Content=(new a).extend(function(t){this._content=void 0,this.prepend=function(){return this._content.unshift.apply(this._content,arguments),this},this.content=function(){return this._content=Array.prototype.slice.call(arguments),this},this.append=function(){return this._content.push.apply(this._content,arguments),this},this._context={},this.render=function(t,e){var s=n.merge(this._context,e);this._render(function(n){i(s,function(e){c(n,e,t)})})},this._render=function(t){i(this._content,function(n){t(n.join(""))})},this.constructor=function(){t.constructor.apply(this),this._content=[],n.isArray(this._parent._content)&&this._content.push.apply(this._content,this._parent._content),this.context={}}}),l=(t.content=h().extend(function(t){this.constructor=function(){t.constructor.apply(this),arguments.length>0&&this.content.apply(this,arguments)}}),t.Tag=h().extend(function(t){this._name=null,this.name=function(t){return this._name=t,this},this._attributes=null,this.attributes=function(t){return n.extend(this._attributes,t),this},this.renderAttributes=function(t){i(this._attributes,function(e){var i="";for(var s in e)i+=n.isNull(e[s])?" "+s:" "+s+'="'+e[s]+'"';t(i)})},this.selector=function(t){return u(this._attributes,t),this},this.constructor=function(){t.constructor.call(this),this._attributes=n.isObject(this._parent._attributes)?n.extend({},this._parent._attributes):{};for(var e in arguments)n.isString(arguments[e])?this.selector(arguments[e]):this.attributes(arguments[e])}})),d=t.Single=l().extend(function(t){this._quotesLeft="<",this._quotesRight="/>",this._render=function(n){var e=this;t._render(function(){e.renderAttributes(function(t){n(e._quotesLeft+e._name+t+e._quotesRight)})})}}),f=t.Double=l().extend(function(t){this._quotesOpenLeft="<",this._quotesOpenRight=">",this._quotesCloseLeft="</",this._quotesCloseRight=">",this["return"]=function(){var t=this;return s(t,function(){return arguments.length>0?t.content.apply(t,arguments):t})},this._render=function(n){var e=this;t._render.call(e,function(t){e.renderAttributes(function(i){n(e._quotesOpenLeft+e._name+i+e._quotesOpenRight+t+e._quotesCloseLeft+e._name+e._quotesCloseRight)})})}}),_=t.Doctype=l().extend(function(t){this._name="DOCTYPE",this._quotesLeft="<!",this._quotesRight=">",this._render=function(n){var e=this;t._render(function(){e.renderAttributes(function(t){n(e._quotesLeft+e._name+t+e._quotesRight)})})}}),p=t.doctypes={};p.html=_("[html]").extend(),p.transitional=_('[html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"]').extend(),p.strict=_('[html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"').extend(),p.frameset=_('[html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd"]').extend(),p.basic=_('[html PUBLIC "-//W3C//DTD XHTML Basic 1.1//EN" "http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd"]').extend(),p.mobile=_('[html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN" "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd"]').extend();var m=t._singles=["br","hr","img","input","base","frame","link","meta","style"],g=t.singles={};for(var b in m)g[m[b]]=d().name(m[b]).extend();var v=t._doubles=["html","body","head","h1","h2","h3","h4","h5","h6","hgroup","div","p","address","blockquote","pre","ul","ol","li","dl","dt","dd","fieldset","legend","form","noscript","object","table","thead","tbody","tfoot","tr","td","th","col","colgroup","caption","span","b","big","strong","i","var","cite","em","q","del","s","strike","tt","code","kbd","samp","small","sub","sup","dfn","bdo","abbr","acronym","a","button","textarea","select","option","article","aside","figcaption","figure","footer","header","section","main","nav","menu","audio","video","embed","canvas","output","details","summary","mark","meter","progress","template","comment","title","script"],x=t.doubles={};for(var b in v)x[v[b]]=f()().name(v[b]).extend()});