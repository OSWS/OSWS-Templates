define(["exports","lodash","async"],function(t,e,n){var i=(t.isSync=function(t){return e.isFunction(t)&&0==t.length},t.isAsync=function(t){return e.isFunction(t)&&1==t.length},t.dataRender=function(t,s){if(e.isFunction(t))t.prototype instanceof h?t.prototype instanceof f?t()()._render(s):t()._render(s):t.__templatesInstance instanceof h?t.__templatesInstance._render(s):1==t.length?t(s):s(0==t.length?t():t);else if(e.isObject(t))if(t instanceof h)t._render(s);else{var r;r=e.isArray(t)?[]:{};var o=e.keys(t);n.each(o,function(e,n){i(t[e],function(t){r[e]=t,n()})},function(){s(r)})}else s(t)}),s=t.wrapMethod=function(t,e){return e.__templatesInstance=t,e},r=t.regExpSearch=function(t,e){for(var n=[],i=null;null!=(i=e.exec(t));)i.index===e.lastIndex&&e.lastIndex++,n.push(i);return n},o=t._selectorRegExp=/(\[)|(\])|#([-\w\d]+)|\.([-\w\d]+)|([\w\d-]+)="(['\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]*)"|([\w\d-]+)='(["\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]*)'|([\w\d-]+)=([\w\d-:\\\/\.={}<>%@#$%^&*~`]*)|("['\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]+")|('["\w\d\s-:\\\/\.\,\]\[={}<>%@#$%^&*~`]+')|([_\w-:\\\/]+)/g,u=t.parseSelector=function(t,n){var i=r(n,o),s=!1;e.each(i,function(e){if(e[1])return void(s=!0);if(e[2])return void(s=!1);if(s){if(e[9])return void(t[e[9]]=e[10]);if(e[7])return void(t[e[7]]=e[8]);if(e[5])return void(t[e[5]]=e[6]);if(e[13])return void(t[e[13]]=null);if(e[12])return void(t[e[12]]=null);if(e[11])return void(t[e[11]]=null)}else{if(e[3])return void(t.id=e[3]);if(e[4])return void(t["class"]?t["class"]+=" "+e[4]:t["class"]=e[4])}})},a=t._stringTemplate=function(t,n,i){i(e.template(t,n))},c=t.Prototype=function(){this._parent=void 0,this._arguments=void 0,this["return"]=function(){return this},this.constructor=function(){},this.extend=function(t){function n(){if(!(this instanceof c)){s=arguments;var r=new n;return r["return"](r)}if(e.isArguments(s)){var o=s;s=void 0}else var o=arguments;this._parent=i,this._arguments=o,e.isFunction(t)&&t.call(this,i),e.isFunction(this.constructor)&&this.constructor.apply(this,o)}var i=this,s=void 0;return n.prototype=i,n}},h=t.Content=(new c).extend(function(t){this._content=void 0,this.prepend=function(){return this._content.unshift.apply(this._content,arguments),this},this.content=function(){return this._content=Array.prototype.slice.call(arguments),this},this.append=function(){return this._content.push.apply(this._content,arguments),this},this._context={},this.render=function(t,n){var i=e.merge(this._context,n);this._render(function(e){a(e,i,t)})},this._render=function(t){i(this._content,function(e){t(e.join(""))})},this.constructor=function(){t.constructor.apply(this),this._content=[],e.isArray(this._parent._content)&&this._content.push.apply(this._content,this._parent._content),this.context={}}}),l=(t.content=h().extend(function(t){this.constructor=function(){t.constructor.apply(this),arguments.length>0&&this.content.apply(this,arguments)}}),t.Tag=h().extend(function(t){this._name=null,this.name=function(t){return this._name=t,this},this._attributes=null,this.attributes=function(t){return e.extend(this._attributes,t),this},this.renderAttributes=function(t){i(this._attributes,function(n){var i="";for(var s in n)i+=e.isNull(n[s])?" "+s:" "+s+'="'+n[s]+'"';t(i)})},this.selector=function(t){return u(this._attributes,t),this},this.constructor=function(){t.constructor.call(this),this._attributes=e.isObject(this._parent._attributes)?e.extend({},this._parent._attributes):{};for(var n in arguments)e.isString(arguments[n])?this.selector(arguments[n]):this.attributes(arguments[n])}})),d=t.Single=l().extend(function(t){this._quotesLeft="<",this._quotesRight="/>",this._render=function(e){var n=this;t._render(function(){n.renderAttributes(function(t){e(n._quotesLeft+n._name+t+n._quotesRight)})})}}),f=t.Double=l().extend(function(t){this._quotesOpenLeft="<",this._quotesOpenRight=">",this._quotesCloseLeft="</",this._quotesCloseRight=">",this["return"]=function(){var t=this;return s(t,function(){return arguments.length>0?t.content.apply(t,arguments):t})},this._render=function(e){var n=this;t._render.call(n,function(t){n.renderAttributes(function(i){e(n._quotesOpenLeft+n._name+i+n._quotesOpenRight+t+n._quotesCloseLeft+n._name+n._quotesCloseRight)})})}}),p=t.Doctype=l().extend(function(t){this._name="DOCTYPE",this._quotesLeft="<!",this._quotesRight=">",this._render=function(e){var n=this;t._render(function(){n.renderAttributes(function(t){e(n._quotesLeft+n._name+t+n._quotesRight)})})}}),_=t.doctypes={};_.html=p("[html]").extend(),_.transitional=p('[html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"]').extend(),_.strict=p('[html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"').extend(),_.frameset=p('[html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd"]').extend(),_.basic=p('[html PUBLIC "-//W3C//DTD XHTML Basic 1.1//EN" "http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd"]').extend(),_.mobile=p('[html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN" "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd"]').extend();var m=t._singles=["br","hr","img","input","base","frame","link","meta","style"],g=t.singles={};for(var b in m)g[m[b]]=d().name(m[b]).extend();var v=t._doubles=["html","body","head","h1","h2","h3","h4","h5","h6","hgroup","div","p","address","blockquote","pre","ul","ol","li","dl","dt","dd","fieldset","legend","form","noscript","object","table","thead","tbody","tfoot","tr","td","th","col","colgroup","caption","span","b","big","strong","i","var","cite","em","q","del","s","strike","tt","code","kbd","samp","small","sub","sup","dfn","bdo","abbr","acronym","a","button","textarea","select","option","article","aside","figcaption","figure","footer","header","section","main","nav","menu","audio","video","embed","canvas","output","details","summary","mark","meter","progress","template","comment","title","script"],x=t.doubles={};for(var b in v)x[v[b]]=f()().name(v[b]).extend()});